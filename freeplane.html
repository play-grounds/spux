<script
  type="application/ld+json"
  id="data"
  view="https://unpkg.com/spux-rocks/freeplane.js"
>
  {
    "map": {
      "version": "freeplane 1.8.0",
      "node": {
        "TEXT": "test",
        "FOLDED": "false",
        "ID": "ID_1885264991",
        "CREATED": "1594489389320",
        "MODIFIED": "1594489413709",
        "LINK": "../index.mm",
        "STYLE": "oval",
        "$t": "",
        "font": {
          "SIZE": "18"
        },
        "hook": [
          {
            "NAME": "MapStyle",
            "properties": {
              "edgeColorConfiguration": "#808080ff,#ff0000ff,#0000ffff,#00ff00ff,#ff00ffff,#00ffffff,#7c0000ff,#00007cff,#007c00ff,#7c007cff,#007c7cff,#7c7c00ff",
              "fit_to_viewport": "false"
            },
            "map_styles": {
              "stylenode": {
                "LOCALIZED_TEXT": "styles.root_node",
                "STYLE": "oval",
                "UNIFORM_SHAPE": "true",
                "VGAP_QUANTITY": "24.0 pt",
                "$t": "",
                "font": {
                  "SIZE": "24"
                },
                "stylenode": [
                  {
                    "LOCALIZED_TEXT": "styles.predefined",
                    "POSITION": "right",
                    "STYLE": "bubble",
                    "stylenode": [
                      {
                        "LOCALIZED_TEXT": "default",
                        "ICON_SIZE": "12.0 pt",
                        "COLOR": "#000000",
                        "STYLE": "fork",
                        "font": {
                          "NAME": "SansSerif",
                          "SIZE": "10",
                          "BOLD": "false",
                          "ITALIC": "false"
                        }
                      },
                      {
                        "LOCALIZED_TEXT": "defaultstyle.details"
                      },
                      {
                        "LOCALIZED_TEXT": "defaultstyle.attributes",
                        "font": {
                          "SIZE": "9"
                        }
                      },
                      {
                        "LOCALIZED_TEXT": "defaultstyle.note",
                        "COLOR": "#000000",
                        "BACKGROUND_COLOR": "#ffffff",
                        "TEXT_ALIGN": "LEFT"
                      },
                      {
                        "LOCALIZED_TEXT": "defaultstyle.floating",
                        "edge": {
                          "STYLE": "hide_edge"
                        },
                        "cloud": {
                          "COLOR": "#f0f0f0",
                          "SHAPE": "ROUND_RECT"
                        }
                      }
                    ]
                  },
                  {
                    "LOCALIZED_TEXT": "styles.user-defined",
                    "POSITION": "right",
                    "STYLE": "bubble",
                    "stylenode": [
                      {
                        "LOCALIZED_TEXT": "styles.topic",
                        "COLOR": "#18898b",
                        "STYLE": "fork",
                        "font": {
                          "NAME": "Liberation Sans",
                          "SIZE": "10",
                          "BOLD": "true"
                        }
                      },
                      {
                        "LOCALIZED_TEXT": "styles.subtopic",
                        "COLOR": "#cc3300",
                        "STYLE": "fork",
                        "font": {
                          "NAME": "Liberation Sans",
                          "SIZE": "10",
                          "BOLD": "true"
                        }
                      },
                      {
                        "LOCALIZED_TEXT": "styles.subsubtopic",
                        "COLOR": "#669900",
                        "font": {
                          "NAME": "Liberation Sans",
                          "SIZE": "10",
                          "BOLD": "true"
                        }
                      },
                      {
                        "LOCALIZED_TEXT": "styles.important",
                        "icon": {
                          "BUILTIN": "yes"
                        }
                      }
                    ]
                  },
                  {
                    "LOCALIZED_TEXT": "styles.AutomaticLayout",
                    "POSITION": "right",
                    "STYLE": "bubble",
                    "$t": "",
                    "stylenode": [
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level.root",
                        "COLOR": "#000000",
                        "STYLE": "oval",
                        "SHAPE_HORIZONTAL_MARGIN": "10.0 pt",
                        "SHAPE_VERTICAL_MARGIN": "10.0 pt",
                        "font": {
                          "SIZE": "18"
                        }
                      },
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level,1",
                        "COLOR": "#0033ff",
                        "font": {
                          "SIZE": "16"
                        }
                      },
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level,2",
                        "COLOR": "#00b439",
                        "font": {
                          "SIZE": "14"
                        }
                      },
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level,3",
                        "COLOR": "#990000",
                        "font": {
                          "SIZE": "12"
                        }
                      },
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level,4",
                        "COLOR": "#111111",
                        "font": {
                          "SIZE": "10"
                        }
                      },
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level,5"
                      },
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level,6"
                      },
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level,7"
                      },
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level,8"
                      },
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level,9"
                      },
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level,10"
                      },
                      {
                        "LOCALIZED_TEXT": "AutomaticLayout.level,11"
                      }
                    ]
                  }
                ]
              }
            }
          },
          {
            "NAME": "AutomaticEdgeColor",
            "COUNTER": "1",
            "RULE": "ON_BRANCH_CREATION"
          }
        ],
        "node": {
          "TEXT": "App",
          "POSITION": "right",
          "ID": "ID_342078243",
          "CREATED": "1594489436194",
          "MODIFIED": "1594504773515",
          "$t": "",
          "edge": {
            "COLOR": "#ff0000"
          },
          "node": {
            "TEXT": "Video",
            "ID": "ID_783607532",
            "CREATED": "1594493138379",
            "MODIFIED": "1594504777243",
            "$t": "",
            "node": [
              {
                "TEXT": "Greenland",
                "ID": "ID_296820527",
                "CREATED": "1594493130659",
                "MODIFIED": "1594504783167",
                "$t": "",
                "node": {
                  "TEXT": "Greenland",
                  "ID": "ID_1480455907",
                  "CREATED": "1594504799790",
                  "MODIFIED": "1594504806523",
                  "LINK": "https://www.youtube.com/watch?v=f7hbWvHKns0"
                }
              },
              {
                "TEXT": "GREENLAND - LAND OF ICE 4K",
                "ID": "ID_1730249274",
                "CREATED": "1594504870740",
                "MODIFIED": "1594504872498"
              },
              {
                "TEXT": "22. 11. 2018",
                "ID": "ID_441399998",
                "CREATED": "1594504894209",
                "MODIFIED": "1594504895732"
              }
            ]
          }
        }
      }
    }
  }
</script>
<script type="module">
  import 'https://unpkg.com/dataisland?module'
  import { h, html, render, Component } from 'https://unpkg.com/spux?module'
  import updateThis from 'https://unpkg.com/spux-modules@0.0.4/updatethis.js'
  import Navbar from 'https://unpkg.com/spux-components/Navbar.js'
  import MediaObject from 'https://unpkg.com/spux-components/MediaObject.js'
  import Plyr from 'https://jspm.dev/plyr'
  import handleMutation from './js/handlemutation.js'
  import refreshThis from 'https://unpkg.com/spux-modules/refreshthis.js'

  globalThis.refreshThis = refreshThis

  var arr
  var id = 'data'

  globalThis.defaults = globalThis.defaults || {}
  globalThis.defaults._target = globalThis.defaults._target || document.body

  document.head.insertAdjacentHTML(
    'beforeend',
    `<link rel="stylesheet" href="https://unpkg.com/spux-rocks/freeplane.css" />`
  )

  // render
  document.head.insertAdjacentHTML(
    'beforeend',
    `<link rel="stylesheet" href="https://unpkg.com/plyr@3/dist/plyr.css" />`
  )

  document.head.insertAdjacentHTML(
    'beforeend',
    `<link rel="stylesheet" href="https://unpkg.com/spux-components/css/spux.css" />`
  )

  const NodeText = props => {
    if (props.node.LINK) {
      var weblink = props.node.LINK.replace(/\.mm$/, '.html')
      return html`
        <span class="${props.caret ? 'caret' : ''}"
          ><a style="color: #3B5998; font-weight: bold" href="${weblink}"
            >âž¥ ${props.node.TEXT}</a
          ></span
        >
      `
    } else {
      return html`
        <span class="${props.caret ? 'caret' : ''}">${props.node.TEXT}</span>
      `
    }
  }

  const Node = props => {
    var children = props.node.node ? [].concat(props.node.node) : []
    var caret = !!children.length
    console.log('TEXT', props.node.TEXT)
    console.log('children', children)
    return html`
      <ul class="active">
        <li id=${props.node.ID}>
          <${NodeText} caret=${caret} node="${props.node}" />
        </li>
        <ul>
          ${children.map(i => {
            return html`
              <${Node} node=${i} />
            `
          })}
        </ul>
      </ul>
    `
  }

  class App extends Component {
    constructor (props) {
      super(props)
      this.processMutation = this.processMutation.bind(this)
      this.state = {
        updates: 0
      }
    }

    componentDidMount () {
      handleMutation(id, this.processMutation)
    }

    processMutation () {
      //   this.forceReload()
      console.log('mutation')
      this.setState({ updates: this.state.updates + 1 })
    }

    render () {
      return html`
        <div id="myUL">
          <${Navbar} title="${di.data.map.node.TEXT}" />
          <${Node} node=${di.data.map.node} title=${this.state.updates} />
        </div>
      `
    }
  }

  render(h(App), globalThis.defaults._target)

  var videos = [...document.getElementsByTagName('li')].filter(i =>
    i.children[0]?.children[0]?.href.match(/youtube.com/)
  )

  setTimeout(() => {
    console.log(MediaObject)
    render(
      html`
        <${MediaObject}
          style="max-width: 854px; height: 480px;"
          contentUrl="${videos[0].children[0]?.children[0]?.href}"
        />
      `,
      videos[0]
    )

    globalThis.player = new Plyr('#player', {})
  }, 500)
</script>
